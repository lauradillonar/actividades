<html lang="en">
<head>
<script language="javascript" type="text/javascript">

var frame=0;
var fps=0;
var x=0;
var y=480-79-32;
var xStage=0;
var imgX=0;
var imgY=244;
var imgW=81;
var imgH=81;
var velocity=0.5; //30 px por seg
var yJumpMario=0;
var yJump=0;
var jumpPacman = false;
var jumpMario = false;
var timeJump=0;
var timeJumpMario=0;

window.onload=function(){
	canvas=document.getElementById("miCanvas");
	canvas.width = 640;
	canvas.height= 480;
	if(canvas && canvas.getContext){
		ctx = canvas.getContext("2d");
		if(ctx){
            imgStage= new Image();
			imgStage.src="./img/Stage01.png";
			imgGrass= new Image();
            imgGrass.src="./img/grass-128x32.png";
            imgStage.onload=function(){
                imgEnemies=new Image();
                imgEnemies.src="./img/mario-enemies.png";
				imgMario=new Image();
				imgMario.src="./img/mario-sprites.png";
				imgMario.onload=function(){
					init_animation();
				}
			}
		}else{
			alert("Error al crear el contexto");
		}
	}
}

//*** CLASS Mario ***//
function Mario(vel, posX, posY){
    this.vel = vel;
    this.posX = posX;
    this.posY = posY;
}

Mario.prototype.walk = function(){
    if(this.posX < canvas.width){
        this.posX = this.posX + this.vel;
    }else{
        this.posX = x;
        this.posY = y;
    }

    if(!jumpMario){
        ctx.drawImage(imgMario, 81*frame,imgY , imgW,imgH , this.posX,this.posY, imgW,imgH);
    }else{
        ctx.drawImage(imgMario, 81*frame,imgY , imgW,imgH , this.posX,this.posY-yJumpMario, imgW,imgH);
        if (fps % 6 === 0){
            timeJumpMario++;
            if(timeJumpMario>0 && timeJumpMario<4){
                yJumpMario = yJumpMario+20;
            }
            if(timeJumpMario>4 && timeJumpMario<8){
                yJumpMario = yJumpMario-20;
            }
            if(timeJumpMario === 8){
                jumpMario=false;
                yJumpMario=0;
            }
        }     
    }

    fps++;
    if (fps % 6 === 0){ //baja velocidad de 60 fps a 10 fps
        frame++;
        if(frame > 2){
            frame=0;
        }
    }
}


// *** CLASS Pacman *** //
function Pacman(vel, posX, posY){
    this.vel = vel;
    this.posX = posX;
    this.posY = posY;
}

Pacman.prototype.walk = function(){
    if(this.posX < canvas.width){
        this.posX = this.posX + this.vel;
    }else{
        this.posX = x;
        this.posY = y;
    }

    if(!jumpPacman){
        ctx.drawImage(imgPacman, 32*frame,imgY , imgW,imgH , this.posX,this.posY, imgW,imgH);
    }else{
        ctx.drawImage(imgPacman, 32*frame,imgY , imgW,imgH , this.posX,this.posY-yJump, imgW,imgH);
        if (fps % 6 === 0){
            timeJump++;
            if(timeJump>0 && timeJump<4){
                yJump = yJump+10;
            }
            if(timeJump>4 && timeJump<8){
                yJump = yJump-10;
            }
            if(timeJump === 8){
                jumpPacman=false;
                yJump=0;
            }
        }     
    }

    fps++;
    if (fps % 6 === 0){ //baja velocidad de 60 fps a 10 fps
        frame++;
        if(frame > 8){
            frame=0;
        }
    }
}



//*** CLASS Stage ***//
function Stage (vel, posX, posY) {
    this.vel = vel;
    this.posX = posX;
    this.posY = posY;
}

Stage.prototype.show = function(){
    if(fps%3===0){
        xStage=xStage-1;
        if(xStage<=-canvas.width) xStage=0;
    }
    //ctx.drawImage(imgStage,0,0, imgStage.width, imgStage.height, -canvas.width+this.posX+xStage, this.posY,  canvas.width, canvas.height);
    ctx.drawImage(imgStage,0,0, imgStage.width, imgStage.height, canvas.width+this.posX+xStage, this.posY,  canvas.width, canvas.height-32);
    ctx.drawImage(imgStage,0,0, imgStage.width, imgStage.height, this.posX+xStage, this.posY,  canvas.width, canvas.height-32);
}

//*** CLASS Grass ***//
function Grass(vel, posX, posY){
    this.vel = vel;
    this.posX = posX;
    this.posY = posY;
}

Grass.prototype.show = function(){
    for(let i=0; i<5; i++){
        ctx.drawImage(imgGrass,0,0,128,32,this.posX+i*128,this.posY,128,32);
        
    }
}

//*** Inicia AnimaciÃ³n ***//

function init_animation(){
    mario = new Mario(velocity,x,y);
    stage = new Stage(velocity,0,0);
    grass = new Grass(0,0,canvas.height-32);

    animation();
    
}

function animation(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    stage.show();
    grass.show();
    mario.walk();
    


    const fx_animation = requestAnimationFrame(animation);
}

document.addEventListener('click',function(e){
    jumpMario=true;
    yJumpMario=0;
    timeJumpMario=0;
});

</script>
</head>
<body>
	
		<canvas id="miCanvas"></canvas>
	
</body>
</html>